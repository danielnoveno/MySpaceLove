import{a as t,b as k,j as e,H as Pe}from"./app-CpTrn_zj.js";import{A as Le}from"./AuthenticatedLayout-Du1ilKJG.js";import{u as $e,c as Ee,l as Ie,a as Fe,e as Re,M as Te,T as Ue,b as xe,L as Ae,P as fe}from"./TileLayer-C7PZoc5d.js";import"./ApplicationLogo-CIVcEVux.js";import"./transition-D8AHnLll.js";import"./createLucideIcon-C0075d5o.js";import"./index-2Py3zg4-.js";function Be(){return $e().map}const De=Ee(function({positions:d,...c},h){const p=new Ie.Polyline(d,c);return Fe(p,Re(h,{overlayContainer:p}))},function(d,c,h){c.positions!==h.positions&&d.setLatLngs(c.positions)}),_e=[-2.5489,118.0149],be=({primaryColor:l,iconColor:d})=>Ae.divIcon({className:"custom-leaflet-marker",html:`
            <div style="
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
            ">
                <span style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 44px;
                    height: 44px;
                    border-radius: 9999px;
                    background: #ffffff;
                    border: 4px solid ${l};
                    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
                ">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        width="22"
                        height="22"
                        fill="none"
                        stroke="${d}"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </span>
                <span style="
                    width: 10px;
                    height: 10px;
                    border-radius: 9999px;
                    background: ${l};
                    opacity: 0.85;
                    box-shadow: 0 3px 10px rgba(15, 23, 42, 0.25);
                "></span>
            </div>
        `,iconSize:[46,60],iconAnchor:[23,56],tooltipAnchor:[0,-48],popupAnchor:[0,-48]}),Ke=be({primaryColor:"#ec4899",iconColor:"#db2777"}),Ge=be({primaryColor:"#8b5cf6",iconColor:"#7c3aed"});function qe({center:l}){const d=Be();return t.useEffect(()=>{d.setView(l)},[l,d]),null}function F(l,d,c,h){const p=R=>R*Math.PI/180,b=p(c-l),n=p(h-d),w=Math.sin(b/2)*Math.sin(b/2)+Math.cos(p(l))*Math.cos(p(c))*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w)))}function he(l){if(!l)return null;try{return new Intl.DateTimeFormat("id-ID",{dateStyle:"medium",timeStyle:"short"}).format(new Date(l))}catch(d){return console.error("Failed to format timestamp",d),null}}function Xe({auth:l,partner:d,userLocation:c,partnerLocation:h,shareBaseUrl:p,pendingInvitation:y,space:b}){const[n,w]=t.useState(c),[i,R]=t.useState(h),[H,J]=t.useState(c?.updated_at??null),[V,ye]=t.useState(h?.updated_at??null),[g,ke]=t.useState(!1),[W,T]=t.useState(!1),[Z,Q]=t.useState(!1),[X,Y]=t.useState(!1),[C,ee]=t.useState(null),[x,Oe]=t.useState(d),[te,ae]=t.useState(!1),[we,U]=t.useState(!1),[A,B]=t.useState(""),[D,_]=t.useState(""),[se,re]=t.useState(y),[ne,oe]=t.useState(y?.email??null),[ie,le]=t.useState(null),[de,M]=t.useState(null);t.useEffect(()=>{re(y),oe(y?.email??null)},[y]);const[ue,ce]=t.useState(!1),[K,S]=t.useState(null),[P,j]=t.useState(null),v=t.useRef(),G=t.useRef(null),q=t.useRef(null);t.useEffect(()=>(ke(!0),()=>{v.current&&window.clearTimeout(v.current)}),[]),t.useEffect(()=>{g&&n&&G.current&&G.current.openPopup()},[g,n]),t.useEffect(()=>{g&&x&&i&&q.current&&q.current.openPopup()},[g,x,i]);const o=t.useCallback((s,a)=>{ee({message:s,type:a}),v.current&&window.clearTimeout(v.current),v.current=window.setTimeout(()=>{ee(null)},4e3)},[]),N=t.useCallback(async(s=!1)=>{if(x)try{const a=await k.get(`/api/location/${x.id}`),r=a.data.location?{latitude:a.data.location.latitude,longitude:a.data.location.longitude,updated_at:a.data.location.updated_at}:null;R(r),ye(r?.updated_at??null),!s&&r&&o("Lokasi pasangan diperbarui 💕","success")}catch(a){console.error("Failed to fetch partner location",a),s||o("Gagal mengambil lokasi pasangan.","error")}},[x,o]),je=t.useCallback(async s=>{s.preventDefault(),le(null),ae(!0);try{const a=A.trim(),r=D.trim();if(!a||!r){o("Nama dan email pasangan wajib diisi.","error");return}const u=(await k.post(`/api/spaces/${b.slug}/connect-partner`,{partner_name:a,partner_email:r})).data,f=u.invitation??null;re(f),oe(f?.email??u.partner_account?.email??r),le(u.temporary_password??null),o("Undangan berhasil dikirim. Minta pasanganmu untuk mengonfirmasi.","success"),U(!1),B(""),_("")}catch(a){console.error("Failed to connect partner",a);let r="Gagal menghubungkan pasangan.";if(k.isAxiosError(a)){const m=a.response?.data,u=m?.errors?Object.values(m.errors).flat().find(f=>typeof f=="string"):void 0;u?r=u:typeof m?.message=="string"&&m.message.trim()!==""&&(r=m.message)}o(r,"error")}finally{ae(!1)}},[D,A,o,b.slug]),L=t.useCallback(async(s,a,r)=>{try{const u=(await k.post("/api/location/update",{latitude:s,longitude:a})).data.location;w(u),J(u.updated_at??null),r||o("Lokasimu berhasil diperbarui 💖","success"),await N(!0)}catch(m){console.error("Failed to update location",m),r||o("Gagal memperbarui lokasi.","error")}finally{r||T(!1)}},[N,o]),O=t.useCallback(async s=>{try{const r=await(await fetch("https://ipapi.co/json/")).json();if(r?.latitude&&r?.longitude)await L(Number(r.latitude),Number(r.longitude),s),s||o("Menggunakan lokasi berdasarkan alamat IP.","warning");else throw new Error("IP geolocation did not return coordinates")}catch(a){console.error("IP geolocation fallback failed",a),s||o("Tidak dapat mengambil lokasi otomatis.","error"),s||T(!1)}},[L,o]),$=t.useCallback((s={})=>{const a=s.silent??!1;a||T(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(r=>{L(r.coords.latitude,r.coords.longitude,a)},()=>{O(a)},{enableHighAccuracy:!0,maximumAge:1e4,timeout:1e4}):O(a)},[O,L]);t.useEffect(()=>{if(!g)return;$({silent:!0}),N(!0);const s=window.setInterval(()=>{$({silent:!0}),N(!0)},3e4);return()=>{window.clearInterval(s)}},[N,g,$]);const pe=t.useMemo(()=>n?[n.latitude,n.longitude]:i?[i.latitude,i.longitude]:_e,[i,n]),me=t.useMemo(()=>!n||!i?null:F(n.latitude,n.longitude,i.latitude,i.longitude),[i,n]),z=t.useMemo(()=>P!==null?P:me,[P,me]),E=t.useMemo(()=>he(H),[H]),I=t.useMemo(()=>he(V),[V]),ge=t.useCallback(async(s,a)=>{ce(!0),S(null);try{const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${s.longitude},${s.latitude};${a.longitude},${a.latitude}?overview=full&geometries=geojson`);if(!r.ok)throw new Error(`OSRM request failed with status ${r.status}`);const u=(await r.json()).routes?.[0],f=u?.geometry?.coordinates;if(f&&Array.isArray(f)&&f.length>0){const Ce=f.map(([Me,Se])=>[Se,Me]);M(Ce),typeof u?.distance=="number"?j(u.distance/1e3):j(F(s.latitude,s.longitude,a.latitude,a.longitude))}else M([[s.latitude,s.longitude],[a.latitude,a.longitude]]),j(F(s.latitude,s.longitude,a.latitude,a.longitude)),S("Rute jalan tidak tersedia, menampilkan garis lurus.")}catch(r){console.error("Failed to fetch route",r),M([[s.latitude,s.longitude],[a.latitude,a.longitude]]),j(F(s.latitude,s.longitude,a.latitude,a.longitude)),S("Gagal memuat rute jalan, menampilkan garis lurus.")}finally{ce(!1)}},[]);t.useEffect(()=>{if(g){if(!n||!i){M(null),j(null),S(null);return}ge(n,i)}},[ge,g,i,n]);const ve=t.useCallback(async()=>{if(!n){o("Lokasi belum tersedia. Tekan update lokasi terlebih dahulu.","warning");return}if(!x){o("Pasangan belum terhubung di MySpaceLove.","warning");return}Q(!0);const s=`${p}?lat=${n.latitude}&lng=${n.longitude}`;try{await k.post(`/api/spaces/${b.slug}/location/share`,{latitude:n.latitude,longitude:n.longitude,url:s}),navigator.clipboard?.writeText&&await navigator.clipboard.writeText(s),o("Link lokasi berhasil dikirim dan disalin! 💞","success")}catch(a){console.error("Failed to share location",a),o("Gagal membagikan lokasi.","error")}finally{Q(!1)}},[x,p,o,b.slug,n]),Ne=t.useCallback(async()=>{Y(!0);try{await k.delete("/api/location"),w(null),J(null),o("Berhenti membagikan lokasi.","warning")}catch(s){console.error("Failed to stop sharing",s),o("Gagal menghentikan berbagi lokasi.","error")}finally{Y(!1)}},[o]);return e.jsxs(Le,{header:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:"Berbagi Lokasi Pasangan 💞"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Lihat posisi kalian berdua secara real-time."})]}),children:[e.jsx(Pe,{title:"Berbagi Lokasi"}),e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8 space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"rounded-2xl bg-white p-4 shadow-sm border border-pink-100",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-1",children:"Kamu di sini 💖"}),e.jsx("p",{className:"text-sm text-gray-600",children:n?`${n.latitude.toFixed(5)}, ${n.longitude.toFixed(5)}`:"Belum ada lokasi"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:E?`Terakhir diperbarui: ${E}`:"Belum pernah diperbarui"})]}),e.jsxs("div",{className:"rounded-2xl bg-white p-4 shadow-sm border border-violet-100",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-1",children:"Pasanganmu 💕"}),x?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-gray-600",children:i?`${i.latitude.toFixed(5)}, ${i.longitude.toFixed(5)}`:"Belum ada lokasi"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:I?`Terakhir diperbarui: ${I}`:"Menunggu pasangan update lokasi"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Kirim undangan ke pasanganmu untuk mulai berbagi."}),se&&e.jsxs("div",{className:"rounded-lg border border-violet-200 bg-violet-50 px-3 py-2 text-xs text-violet-700",children:["Menunggu konfirmasi dari"," ",e.jsx("span",{className:"font-semibold",children:se.email}),". Mintalah pasanganmu untuk login dan menerima undangan yang sudah kamu kirim."]}),we?e.jsxs("form",{className:"space-y-3 rounded-xl border border-violet-100 bg-violet-50 p-3",onSubmit:je,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-semibold uppercase tracking-wide text-gray-600",children:"Nama Pasangan"}),e.jsx("input",{value:A,onChange:s=>B(s.target.value),required:!0,className:"w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-purple-500 focus:ring-purple-500",placeholder:"Misal: Hana"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-semibold uppercase tracking-wide text-gray-600",children:"Email Pasangan"}),e.jsx("input",{type:"email",value:D,onChange:s=>_(s.target.value),required:!0,className:"w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-purple-500 focus:ring-purple-500",placeholder:"pasangan@email.com"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"submit",disabled:te,className:"inline-flex items-center justify-center rounded-full bg-purple-500 px-4 py-2 text-sm font-medium text-white shadow transition hover:bg-purple-600 disabled:cursor-not-allowed disabled:bg-purple-300",children:te?"Mengirim...":"Kirim Undangan"}),e.jsx("button",{type:"button",onClick:()=>{U(!1),B(""),_("")},className:"inline-flex items-center justify-center rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-600 shadow-sm transition hover:bg-gray-50",children:"Batal"})]})]}):e.jsx("button",{type:"button",onClick:()=>U(!0),className:"inline-flex items-center gap-2 rounded-full bg-purple-100 px-4 py-2 text-sm font-medium text-purple-600 transition hover:bg-purple-200",children:"Kirim Undangan ke Pasangan"})]})]})]}),ie&&ne&&e.jsxs("div",{className:"rounded-2xl border border-yellow-200 bg-yellow-50 px-4 py-3 text-sm text-yellow-800 shadow-sm",children:[e.jsx("p",{className:"font-semibold",children:"Akun pasangan berhasil dibuat otomatis."}),e.jsxs("p",{className:"mt-1",children:["Bagikan kredensial ini ke pasanganmu untuk login:",e.jsx("br",{}),e.jsx("span",{className:"font-semibold",children:"Email:"})," ",ne," ",e.jsx("span",{className:"font-semibold",children:"Password:"})," ",e.jsx("span",{className:"font-mono tracking-wide",children:ie})]})]}),z!==null&&e.jsx("div",{className:"rounded-2xl bg-gradient-to-r from-pink-500 to-purple-500 px-6 py-4 text-white shadow-lg",children:e.jsx("p",{className:"text-sm font-semibold",children:P!==null?`Jarak estimasi via jalan sekitar ${z.toFixed(2)} km 🚗`:`Jarak garis lurus kalian sekitar ${z.toFixed(2)} km 🌍`})}),e.jsxs("div",{className:"bg-white rounded-3xl shadow-lg border border-pink-100 p-4",children:[e.jsx("div",{className:"h-[420px] w-full overflow-hidden rounded-2xl",children:g?e.jsxs(Te,{center:pe,zoom:13,className:"h-full w-full",scrollWheelZoom:!0,children:[e.jsx(qe,{center:pe}),e.jsx(Ue,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),n&&e.jsx(xe,{ref:G,position:[n.latitude,n.longitude],icon:Ke,children:e.jsxs(fe,{autoClose:!1,closeButton:!1,closeOnClick:!1,autoPan:!1,children:[e.jsx("span",{className:"font-semibold text-pink-500",children:"Kamu di sini 💖"}),e.jsx("br",{}),E?`Terakhir update: ${E}`:"Belum ada data"]})}),x&&i&&e.jsx(xe,{ref:q,position:[i.latitude,i.longitude],icon:Ge,children:e.jsxs(fe,{autoClose:!1,closeButton:!1,closeOnClick:!1,autoPan:!1,children:[e.jsx("span",{className:"font-semibold text-purple-500",children:"Pasanganmu 💕"}),e.jsx("br",{}),I?`Terakhir update: ${I}`:"Belum ada data"]})}),de&&e.jsx(De,{positions:de,pathOptions:{color:"#ec4899",weight:5,opacity:.75,lineCap:"round",lineJoin:"round"}})]}):e.jsx("div",{className:"flex h-full items-center justify-center text-sm text-gray-500",children:"Memuat peta..."})}),(ue||K)&&e.jsxs("div",{className:"mt-3 px-1 space-y-1",children:[ue&&e.jsx("p",{className:"text-xs text-gray-500",children:"Menentukan jalur terbaik..."}),K&&e.jsx("p",{className:"text-xs text-yellow-600",children:K})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{onClick:()=>$({silent:!1}),disabled:W,className:"inline-flex items-center gap-2 rounded-full bg-pink-500 px-5 py-2 text-white shadow transition hover:bg-pink-600 disabled:cursor-not-allowed disabled:bg-pink-300",children:W?"Memperbarui...":"📍 Update Lokasi"}),e.jsx("button",{onClick:ve,disabled:Z,className:"inline-flex items-center gap-2 rounded-full bg-purple-500 px-5 py-2 text-white shadow transition hover:bg-purple-600 disabled:cursor-not-allowed disabled:bg-purple-300",children:Z?"Mengirim...":"🔗 Share Lokasi"}),e.jsx("button",{onClick:Ne,disabled:X,className:"inline-flex items-center gap-2 rounded-full bg-gray-200 px-5 py-2 text-gray-700 shadow transition hover:bg-gray-300 disabled:cursor-not-allowed disabled:opacity-70",children:X?"Memproses...":"⛔ Stop Sharing"})]}),C&&e.jsx("div",{className:`fixed bottom-6 right-6 z-50 rounded-2xl px-4 py-3 text-sm shadow-lg transition ${C.type==="success"?"bg-white border border-green-200 text-green-600":C.type==="error"?"bg-white border border-red-200 text-red-600":"bg-white border border-yellow-200 text-yellow-600"}`,children:C.message})]})]})}export{Xe as default};
